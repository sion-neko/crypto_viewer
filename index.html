<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暗号資産ポートフォリオビューアー</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- ハンバーガーメニューボタン（モバイルのみ） -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="メニュー">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- オーバーレイ（モバイルのみ） -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ホバートリガーエリア -->
    <div class="sidebar-trigger"></div>

    <!-- サイドバー -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>ポートフォリオビューアー</h1>
            <p style="font-size: 0.9rem; color: #7f8c8d; margin: 0;">暗号資産分析ツール</p>
        </div>

        <nav>
            <button class="nav-item active"
                onclick="document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); document.getElementById('page-dashboard').classList.add('active'); this.classList.add('active');"
                id="nav-dashboard">
                ダッシュボード
            </button>
            <button class="nav-item"
                onclick="document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); document.getElementById('page-upload').classList.add('active'); this.classList.add('active');"
                id="nav-upload">
                CSVアップロード
            </button>
        </nav>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content">
        <div class="container">
            <!-- ダッシュボードページ -->
            <div id="page-dashboard" class="page-content active">
                <div class="header">
                    <h1>ポートフォリオダッシュボード</h1>
                    <p>あなたの暗号資産投資の詳細分析</p>
                </div>

                <div class="dashboard-area" id="dashboardArea">
                    <div class="no-data-message">
                        <h3>データがありません</h3>
                        <p>CSVファイルをアップロードしてポートフォリオを表示してください</p>
                        <button class="nav-button"
                            onclick="document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); document.getElementById('page-upload').classList.add('active'); document.getElementById('nav-upload').classList.add('active');">CSVをアップロード</button>
                    </div>
                </div>

                <!-- タブコンテンツエリア（データがある時に表示） -->
                <div class="tab-container" id="tabContainer" style="display: none;">
                    <div class="tab-nav">
                        <button class="tab-button active" onclick="window.uiService.switchMainTab('portfolio')"
                            title="Ctrl+1 でポートフォリオタブに切り替え">ポートフォリオ</button>
                        <button class="tab-button" onclick="window.uiService.switchMainTab('trading')"
                            title="Ctrl+2 で取引履歴タブに切り替え">取引履歴</button>
                    </div>

                    <!-- ポートフォリオタブ -->
                    <div class="tab-content active" id="tab-portfolio">
                        <!-- サブタブナビゲーション -->
                        <div class="subtab-nav" id="subtab-nav">
                            <button class="subtab-button active" onclick="window.uiService.switchSubTab('summary')"
                                id="subtab-summary"
                                title="Ctrl+S でサマリーに切り替え / Ctrl+← 前のサブタブ / Ctrl+→ 次のサブタブ">サマリー</button>
                            <!-- 銘柄別サブタブはJSで動的生成 -->
                        </div>

                        <!-- サマリータブ内容 -->
                        <div class="subtab-content active" id="subtab-content-summary">
                            <!-- 価格更新セクション -->
                            <div id="price-update-section"
                                style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <button onclick="window.uiService.fetchCurrentPrices()"
                                        style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.3s;"
                                        onmouseover="this.style.background='#2563eb'"
                                        onmouseout="this.style.background='#3b82f6'">
                                        価格更新
                                    </button>
                                    <span style="margin-left: 15px; font-size: 0.9rem; color: #6c757d;">
                                        CoinGecko APIから最新価格を取得
                                    </span>
                                </div>
                                <div id="price-update-status" style="font-size: 0.85rem; color: #6c757d;">
                                    価格データなし
                                </div>
                            </div>

                            <div id="portfolio-table-container">
                                <!-- ポートフォリオテーブルをここに表示 -->
                            </div>
                        </div>

                        <!-- 銘柄別サブタブ内容（JSで動的生成） -->
                        <div id="coinName-subtabs-container"></div>
                    </div>


                    <!-- 取引履歴タブ -->
                    <div class="tab-content" id="tab-trading">
                        <div class="portfolio-summary">
                            <h3 style="color: #2c3e50;">取引履歴</h3>

                            <!-- 読み込み済みファイル一覧（取引履歴タブ用） -->
                            <div id="trading-files-section" style="margin-bottom: 20px; display: none;">
                                <div
                                    style="background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef; padding: 20px;">
                                    <h4
                                        style="margin: 0 0 15px 0; font-size: 1rem; color: #495057; display: flex; align-items: center; gap: 8px;">
                                        読み込み済みファイル
                                    </h4>
                                    <div id="trading-files-list" style="max-height: 400px; overflow-y: auto;">
                                        <!-- ファイル名がここに表示される -->
                                    </div>

                                    <!-- 全データクリアボタン -->
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                        <button
                                            onclick="if (window.fileService.clearAllData()) { window.uiService.updateDataStatus(null); }"
                                            style="width: 100%; padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: background 0.2s ease;"
                                            onmouseover="this.style.background='#5a6268'"
                                            onmouseout="this.style.background='#6c757d'">
                                            全データクリア
                                        </button>
                                        <div
                                            style="font-size: 0.75rem; color: #6c757d; margin-top: 6px; text-align: center; line-height: 1.3;">
                                            全ての取引データと価格データを削除
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="trading-history-container">
                                <!-- 取引履歴テーブルをここに表示 -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- アップロードページ -->
            <div id="page-upload" class="page-content">
                <div class="header">
                    <h1>CSVファイルアップロード</h1>
                    <p>取引履歴CSVをアップロードして、ポートフォリオを分析・可視化</p>
                </div>

                <div class="upload-area">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-text">CSVファイルをドラッグ&ドロップ</div>
                        <div class="upload-subtext">または下のボタンをクリックしてファイルを選択</div>

                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            ファイルを選択
                        </button>
                        <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>

                        <div style="margin-top: 15px; font-size: 0.9rem; color: #6c757d;">
                            取引所は自動判定されます（GMOコイン / OKCoin Japan）
                        </div>
                    </div>
                </div>

                <!-- 読み込み済みファイル一覧 -->
                <div id="upload-files-section" style="margin-top: 20px; margin-bottom: 30px; display: none;">
                    <div style="background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef; padding: 20px;">
                        <h3
                            style="margin: 0 0 15px 0; font-size: 1.1rem; color: #495057; display: flex; align-items: center; gap: 8px;">
                            読み込み済みファイル
                        </h3>
                        <div id="upload-files-list" style="max-height: 300px; overflow-y: auto;">
                            <!-- ファイル名がここに表示される -->
                        </div>

                        <!-- 全データクリアボタン -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                            <button
                                onclick="if (window.fileService.clearAllData()) { window.uiService.updateDataStatus(null); }"
                                style="width: 100%; padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: background 0.2s ease;"
                                onmouseover="this.style.background='#5a6268'"
                                onmouseout="this.style.background='#6c757d'">
                                全データクリア
                            </button>
                            <div
                                style="font-size: 0.75rem; color: #6c757d; margin-top: 6px; text-align: center; line-height: 1.3;">
                                全ての取引データと価格データを削除
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h2 class="info-title">プライバシー保護</h2>
                    <ul class="info-list">
                        <li>あなたのデータは完全にブラウザ内で処理されます</li>
                        <li>ファイルがサーバーにアップロードされることはありません</li>
                        <li>データは端末にのみ保存され、外部に送信されません</li>
                        <li>一度処理したデータは次回も自動で表示されます</li>
                    </ul>

                    <h2 class="info-title" style="margin-top: 25px;">対応形式</h2>
                    <ul class="info-list">
                        <li>GMO コイン取引履歴CSV</li>
                        <li>OKCoin Japan 取引履歴CSV</li>
                        <li>その他の取引所（今後対応予定）</li>
                        <li>複数のCSVファイルを同時アップロード可能</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Papa Parse for CSV processing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Include JavaScript files -->
    <script src="config.js"></script>
    <script src="storage-utils.js"></script>

    <!-- Service Layer (Object-Oriented Architecture) -->
    <script src="services/portfolio-data-service.js"></script>
    <script src="services/api-service.js"></script>
    <script src="services/ui-service.js"></script>
    <script src="services/file-service.js"></script>

    <!-- Legacy files (for backward compatibility) -->
    <script src="main.js"></script>

    <!-- Initialize service instances -->
    <script>
        // Initialize PortfolioDataService instance (no dependencies)
        window.portfolioDataService = new PortfolioDataService();

        // Initialize FileService instance (depends on portfolioDataService and uiService)
        window.fileService = new FileService(window.portfolioDataService, window.uiService);

        console.log('✅ All services initialized successfully');
    </script>
</body>

</html>