<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš—å·è³‡ç”£ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }

        .sidebar-header h1 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .nav-item {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: transparent;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            color: #2c3e50;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 1rem;
            text-align: left;
        }

        .nav-item:hover {
            background: rgba(52, 152, 219, 0.1);
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-color: transparent;
        }

        .nav-item.active:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .upload-area {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-zone {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            background: rgba(52, 152, 219, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #2980b9;
            background: rgba(52, 152, 219, 0.1);
        }

        .upload-zone.drag-over {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .info-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .info-title {
            color: #2c3e50;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .info-list {
            list-style: none;
            color: #555;
        }

        .info-list li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .info-list li::before {
            content: "âœ“";
            color: #27ae60;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .dashboard-area {
            margin-top: 20px;
        }

        .no-data-message {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .no-data-message h3 {
            color: #7f8c8d;
            margin-bottom: 15px;
        }

        .no-data-message p {
            color: #95a5a6;
            margin-bottom: 20px;
        }

        .nav-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        /* ã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ  */
        .tab-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 20px;
        }

        .tab-nav {
            display: flex;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: #6c757d;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(52, 152, 219, 0.1);
            color: #495057;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #2980b9;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .subtab-content {
            display: none;
        }

        .subtab-content.active {
            display: block;
        }

        .subtab-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .subtab-button {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subtab-button:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .subtab-button.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-color: #2980b9;
            color: white !important;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
            transform: translateY(-1px);
        }

        .portfolio-summary {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                margin-bottom: 20px;
            }

            .main-content {
                margin-left: 0;
            }

            .header h1 {
                font-size: 2rem;
            }
            
            .upload-area, .info-section {
                padding: 20px;
            }
            
            .upload-zone {
                padding: 30px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>ğŸš€ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h1>
            <p style="font-size: 0.9rem; color: #7f8c8d; margin: 0;">æš—å·è³‡ç”£åˆ†æãƒ„ãƒ¼ãƒ«</p>
        </div>
        
        <nav>
            <button class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard">
                ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </button>
            <button class="nav-item" onclick="showPage('upload')" id="nav-upload">
                ğŸ“ CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>
        </nav>

        <!-- ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹è¡¨ç¤º -->
        <div style="margin-top: 30px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 10px; font-size: 0.9rem;">
            <div id="data-status" style="color: #7f8c8d;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div id="data-management" style="margin-top: 20px; display: none;">
            <button onclick="clearAllData()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: background 0.3s ease;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
            </button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="container">
            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ -->
            <div id="page-dashboard" class="page-content active">
                <div class="header">
                    <h1>ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                    <p>ã‚ãªãŸã®æš—å·è³‡ç”£æŠ•è³‡ã®è©³ç´°åˆ†æ</p>
                </div>

                <div class="dashboard-area" id="dashboardArea">
                    <div class="no-data-message">
                        <h3>ğŸ“„ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</p>
                        <button class="nav-button" onclick="showPage('upload')">CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                    </div>
                </div>

                <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æ™‚ã«è¡¨ç¤ºï¼‰ -->
                <div class="tab-container" id="tabContainer" style="display: none;">
                    <div class="tab-nav">
                        <button class="tab-button active" onclick="switchTab('portfolio')">ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</button>
                        <button class="tab-button" onclick="switchTab('trading')">ğŸ“ˆ å–å¼•å±¥æ­´</button>
                        <button class="tab-button" onclick="switchTab('charts')">ğŸ“ˆ ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ</button>
                    </div>

                    <!-- ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚¿ãƒ– -->
                    <div class="tab-content active" id="tab-portfolio">
                        <!-- ã‚µãƒ–ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                        <div class="subtab-nav" id="subtab-nav">
                            <button class="subtab-button active" onclick="switchSubtab('summary')" id="subtab-summary">ğŸ“‹ ã‚µãƒãƒªãƒ¼</button>
                            <!-- éŠ˜æŸ„åˆ¥ã‚µãƒ–ã‚¿ãƒ–ã¯JSã§å‹•çš„ç”Ÿæˆ -->
                        </div>

                        <!-- ã‚µãƒãƒªãƒ¼ã‚¿ãƒ–å†…å®¹ -->
                        <div class="subtab-content active" id="subtab-content-summary">
                            <!-- ä¾¡æ ¼æ›´æ–°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <div id="price-update-section" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <button onclick="fetchCurrentPrices()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.3s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                        ğŸ“ˆ ä¾¡æ ¼æ›´æ–°
                                    </button>
                                    <span style="margin-left: 15px; font-size: 0.9rem; color: #6c757d;">
                                        CoinGecko APIã‹ã‚‰æœ€æ–°ä¾¡æ ¼ã‚’å–å¾—
                                    </span>
                                </div>
                                <div id="price-update-status" style="font-size: 0.85rem; color: #6c757d;">
                                    ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãªã—
                                </div>
                            </div>
                            
                            <div id="portfolio-table-container">
                                <!-- ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã“ã“ã«è¡¨ç¤º -->
                            </div>
                        </div>
                        
                        <!-- éŠ˜æŸ„åˆ¥ã‚µãƒ–ã‚¿ãƒ–å†…å®¹ï¼ˆJSã§å‹•çš„ç”Ÿæˆï¼‰ -->
                        <div id="symbol-subtabs-container"></div>
                    </div>


                    <!-- å–å¼•å±¥æ­´ã‚¿ãƒ– -->
                    <div class="tab-content" id="tab-trading">
                        <div class="portfolio-summary">
                            <h3 style="color: #2c3e50;">ğŸ“ˆ å–å¼•å±¥æ­´</h3>
                            <div id="trading-history-container">
                                <!-- å–å¼•å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã“ã“ã«è¡¨ç¤º -->
                            </div>
                        </div>
                    </div>

                    <!-- ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆã‚¿ãƒ– -->
                    <div class="tab-content" id="tab-charts">
                        <div class="portfolio-summary">
                            <h3 style="color: #2c3e50;">ğŸ“ˆ ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ</h3>
                            
                            <!-- ãƒãƒ£ãƒ¼ãƒˆé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                <label for="chart-symbol-select" style="font-weight: bold; margin-right: 10px;">éŠ˜æŸ„é¸æŠ:</label>
                                <select id="chart-symbol-select" onchange="onSymbolSelect()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">-- éŠ˜æŸ„ã‚’é¸æŠ --</option>
                                </select>
                                <button onclick="selectETHChart()" style="margin-left: 10px; padding: 8px 16px; background: #627EEA; color: white; border: none; border-radius: 4px; cursor: pointer;">ETHè¡¨ç¤º</button>
                            </div>
                            
                            <!-- ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
                            <div id="chart-container" style="position: relative; height: 500px; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <canvas id="price-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ -->
            <div id="page-upload" class="page-content">
                <div class="header">
                    <h1>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
                    <p>å–å¼•å±¥æ­´CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’åˆ†æãƒ»å¯è¦–åŒ–</p>
                </div>

                <div class="upload-area">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="upload-subtext">ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
                        
                        <!-- å–å¼•æ‰€é¸æŠ -->
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #2c3e50;">å–å¼•æ‰€ã‚’é¸æŠ:</label>
                            <div style="display: flex; justify-content: center; gap: 20px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="exchange" value="GMO" checked style="margin-right: 8px;">
                                    <span>GMO ã‚³ã‚¤ãƒ³</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="exchange" value="OKJ" style="margin-right: 8px;">
                                    <span>OKCoin Japan</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="exchange" value="AUTO" style="margin-right: 8px;">
                                    <span>è‡ªå‹•åˆ¤å®š</span>
                                </label>
                            </div>
                        </div>
                        
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                        </button>
                        <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>
                    </div>
                </div>

                <div class="info-section">
                    <h2 class="info-title">ğŸ›¡ï¸ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·</h2>
                    <ul class="info-list">
                        <li>ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã¯å®Œå…¨ã«ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã•ã‚Œã¾ã™</li>
                        <li>ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“</li>
                        <li>ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</li>
                        <li>ä¸€åº¦å‡¦ç†ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯æ¬¡å›ã‚‚è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™</li>
                    </ul>

                    <h2 class="info-title" style="margin-top: 25px;">ğŸ“Š å¯¾å¿œå½¢å¼</h2>
                    <ul class="info-list">
                        <li>GMO ã‚³ã‚¤ãƒ³å–å¼•å±¥æ­´CSV</li>
                        <li>OKCoin Japan å–å¼•å±¥æ­´CSV</li>
                        <li>ãã®ä»–ã®å–å¼•æ‰€ï¼ˆä»Šå¾Œå¯¾å¿œäºˆå®šï¼‰</li>
                        <li>è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Papa Parse for CSV processing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®åŸºç¤
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const dashboardArea = document.getElementById('dashboardArea');

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ©Ÿèƒ½
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            handleFiles(files);
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿çµ±åˆç‰ˆï¼‰
        function handleFiles(files) {
            console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', files.length);
            
            const csvFiles = Array.from(files).filter(file => 
                file.type === 'text/csv' || file.name.endsWith('.csv')
            );
            
            if (csvFiles.length === 0) {
                showErrorMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const existingData = getExistingTransactions();
            console.log('æ—¢å­˜å–å¼•ãƒ‡ãƒ¼ã‚¿:', existingData.length, 'ä»¶');
            
            // ä¸¦åˆ—ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            const promises = csvFiles.map(file => parseCSVFile(file));
            
            Promise.all(promises)
                .then(results => {
                    const newData = results.flat();
                    console.log('æ–°è¦å–å¼•ãƒ‡ãƒ¼ã‚¿:', newData.length, 'ä»¶');
                    
                    if (newData.length > 0) {
                        // é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ã—ã¦çµ±åˆ
                        const mergedData = mergeTransactionData(existingData, newData);
                        const addedCount = mergedData.length - existingData.length;
                        
                        console.log('çµ±åˆå¾Œå–å¼•ãƒ‡ãƒ¼ã‚¿:', mergedData.length, 'ä»¶ï¼ˆæ–°è¦è¿½åŠ :', addedCount, 'ä»¶ï¼‰');
                        
                        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå†è¨ˆç®—
                        const portfolioData = analyzePortfolioData(mergedData);
                        
                        // ç”Ÿã®å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜ï¼ˆæ¬¡å›ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
                        localStorage.setItem('rawTransactions', JSON.stringify(mergedData));
                        localStorage.setItem('portfolioData', JSON.stringify(portfolioData));
                        
                        displayDashboard(portfolioData);
                        
                        if (addedCount > 0) {
                            showSuccessMessage(`${csvFiles.length}å€‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã€${addedCount}ä»¶ã®æ–°ã—ã„å–å¼•ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                        } else {
                            showInfoMessage(`${csvFiles.length}å€‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸãŒã€æ–°ã—ã„å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆé‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ï¼‰`);
                        }
                    } else {
                        showErrorMessage('æœ‰åŠ¹ãªå–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                })
                .catch(error => {
                    console.error('CSVå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
        }

        // æ—¢å­˜å–å¼•ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getExistingTransactions() {
            try {
                const rawData = localStorage.getItem('rawTransactions');
                return rawData ? JSON.parse(rawData) : [];
            } catch (error) {
                console.error('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                return [];
            }
        }

        // å–å¼•ãƒ‡ãƒ¼ã‚¿çµ±åˆï¼ˆé‡è¤‡é™¤å¤–ï¼‰
        function mergeTransactionData(existingData, newData) {
            const merged = [...existingData];
            let duplicateCount = 0;
            
            newData.forEach(newTx => {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼šæ—¥æ™‚ãƒ»éŠ˜æŸ„ãƒ»å–å¼•æ‰€ãƒ»æ•°é‡ãƒ»é‡‘é¡ãŒå®Œå…¨ä¸€è‡´
                const isDuplicate = existingData.some(existingTx => 
                    existingTx.date === newTx.date &&
                    existingTx.symbol === newTx.symbol &&
                    existingTx.exchange === newTx.exchange &&
                    Math.abs(existingTx.quantity - newTx.quantity) < 0.00000001 &&
                    Math.abs(existingTx.amount - newTx.amount) < 0.01 &&
                    existingTx.type === newTx.type
                );
                
                if (!isDuplicate) {
                    merged.push(newTx);
                } else {
                    duplicateCount++;
                }
            });
            
            console.log(`é‡è¤‡é™¤å¤–: ${duplicateCount}ä»¶ã®é‡è¤‡å–å¼•ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`);
            return merged;
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«è§£æ
        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        console.log(`${file.name} è§£æå®Œäº†:`, results.data.length, 'è¡Œ');
                        const processedData = processCSVData(results.data, file.name);
                        resolve(processedData);
                    },
                    error: function(error) {
                        console.error(`${file.name} è§£æã‚¨ãƒ©ãƒ¼:`, error);
                        reject(error);
                    }
                });
            });
        }

        // CSV ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆGMOãƒ»OKJå¯¾å¿œï¼‰
        function processCSVData(data, fileName) {
            const transactions = [];
            const selectedExchange = document.querySelector('input[name="exchange"]:checked').value;
            
            data.forEach(row => {
                // GMOã‚³ã‚¤ãƒ³å½¢å¼
                if ((selectedExchange === 'GMO' || selectedExchange === 'AUTO') && 
                    row['ç²¾ç®—åŒºåˆ†'] && row['ç²¾ç®—åŒºåˆ†'].includes('å–å¼•æ‰€ç¾ç‰©å–å¼•')) {
                    const symbol = row['éŠ˜æŸ„å'];
                    if (symbol && symbol !== 'JPY') {
                        const transaction = {
                            exchange: 'GMO',
                            symbol: symbol,
                            type: row['å£²è²·åŒºåˆ†'], // è²· or å£²
                            amount: parseFloat(row['æ—¥æœ¬å††å—æ¸¡é‡‘é¡']?.replace(/,/g, '') || 0),
                            quantity: parseFloat(row['ç´„å®šæ•°é‡']?.replace(/,/g, '') || 0),
                            fee: parseFloat(row['æ³¨æ–‡æ‰‹æ•°æ–™']?.replace(/,/g, '') || 0),
                            date: row['ç´„å®šæ—¥æ™‚'],
                            rate: parseFloat(row['ç´„å®šãƒ¬ãƒ¼ãƒˆ']?.replace(/,/g, '') || 0)
                        };
                        
                        if (transaction.quantity > 0) {
                            transactions.push(transaction);
                        }
                    }
                }
                
                // OKCoin Japanå½¢å¼
                if ((selectedExchange === 'OKJ' || selectedExchange === 'AUTO') && 
                    row['å–å¼•éŠ˜æŸ„'] && row['å£²è²·'] && row['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'] === 'å…¨éƒ¨ç´„å®š') {
                    const pair = row['å–å¼•éŠ˜æŸ„'];
                    const symbol = pair.replace('/JPY', '');
                    
                    if (symbol !== 'JPY' && row['å£²è²·'] === 'è³¼å…¥') {
                        const transaction = {
                            exchange: 'OKJ',
                            symbol: symbol,
                            type: 'è²·', // OKJã®ã€Œè³¼å…¥ã€ã‚’ã€Œè²·ã€ã«çµ±ä¸€
                            amount: parseFloat(row['ç´„å®šä»£é‡‘']?.replace(/,/g, '') || 0),
                            quantity: parseFloat(row['ç´„å®šæ•°é‡']?.replace(/,/g, '') || 0),
                            fee: 0, // OKJã®CSVã«ã¯æ‰‹æ•°æ–™åˆ—ãŒãªã„ãŸã‚0ã¨ã™ã‚‹
                            date: row['æ³¨æ–‡æ—¥æ™‚'],
                            rate: parseFloat(row['å¹³å‡ç´„å®šä¾¡æ ¼']?.replace(/,/g, '') || 0)
                        };
                        
                        if (transaction.quantity > 0 && transaction.amount > 0) {
                            transactions.push(transaction);
                        }
                    }
                }
            });
            
            console.log(`${fileName} (${selectedExchange}): ${transactions.length}ä»¶ã®å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º`);
            return transactions;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showSuccessMessage(message) {
            alert('âœ… ' + message);
        }

        function showErrorMessage(message) {
            alert('âŒ ' + message);
        }

        function showInfoMessage(message) {
            alert('â„¹ï¸ ' + message);
        }

        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªåˆ†æï¼ˆæç›Šè¨ˆç®—å¼·åŒ–ç‰ˆï¼‰
        function analyzePortfolioData(transactions) {
            const symbolData = {};
            
            transactions.forEach(tx => {
                if (!symbolData[tx.symbol]) {
                    symbolData[tx.symbol] = {
                        totalBuyAmount: 0,
                        totalSellAmount: 0,
                        totalQuantity: 0,
                        totalFees: 0,
                        buyTransactions: [],
                        sellTransactions: [],
                        totalBuyQuantity: 0,
                        totalSellQuantity: 0,
                        weightedRateSum: 0,
                        allTransactions: []
                    };
                }
                
                const data = symbolData[tx.symbol];
                data.allTransactions.push(tx);
                
                if (tx.type === 'è²·') {
                    data.totalBuyAmount += tx.amount;
                    data.totalBuyQuantity += tx.quantity;
                    data.weightedRateSum += tx.rate * tx.quantity;
                    data.buyTransactions.push(tx);
                } else if (tx.type === 'å£²') {
                    data.totalSellAmount += tx.amount;
                    data.totalSellQuantity += tx.quantity;
                    data.sellTransactions.push(tx);
                }
                
                data.totalQuantity += tx.type === 'è²·' ? tx.quantity : -tx.quantity;
                data.totalFees += tx.fee;
            });
            
            // å„éŠ˜æŸ„ã®çµ±è¨ˆãƒ»æç›Šè¨ˆç®—
            const portfolioSummary = [];
            let totalInvestment = 0;
            let totalRealizedProfit = 0;
            let totalFees = 0;
            
            Object.keys(symbolData).forEach(symbol => {
                const data = symbolData[symbol];
                const averagePurchaseRate = data.totalBuyQuantity > 0 ? 
                    data.weightedRateSum / data.totalBuyQuantity : 0;
                
                // ç¾åœ¨ã®ä¿æœ‰åˆ†ã®æŠ•è³‡é¡ï¼ˆå¹³å‡è³¼å…¥ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ï¼‰
                const currentHoldingInvestment = data.totalQuantity > 0 ? 
                    data.totalQuantity * averagePurchaseRate : 0;
                
                // å®Ÿç¾æç›Šè¨ˆç®—ï¼ˆå£²å´æ™‚ã®æç›Šï¼‰
                let realizedProfit = 0;
                if (data.totalSellQuantity > 0 && averagePurchaseRate > 0) {
                    // å£²å´é‡‘é¡ - å£²å´åˆ†ã®å¹³å‡è³¼å…¥ã‚³ã‚¹ãƒˆ
                    const soldCost = data.totalSellQuantity * averagePurchaseRate;
                    realizedProfit = data.totalSellAmount - soldCost;
                }
                
                // æŠ•è³‡åŠ¹ç‡è¨ˆç®—
                const investmentEfficiency = data.totalBuyAmount > 0 ? 
                    (realizedProfit / data.totalBuyAmount) * 100 : 0;
                
                const summary = {
                    symbol,
                    holdingQuantity: data.totalQuantity,
                    totalInvestment: data.totalBuyAmount,
                    currentHoldingInvestment,
                    averagePurchaseRate,
                    totalFees: data.totalFees,
                    buyTransactionCount: data.buyTransactions.length,
                    sellTransactionCount: data.sellTransactions.length,
                    totalSellAmount: data.totalSellAmount,
                    realizedProfit,
                    investmentEfficiency,
                    // è¡¨ç¤ºç”¨ã®æç›Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                    profitStatus: realizedProfit > 0 ? 'profit' : realizedProfit < 0 ? 'loss' : 'neutral'
                };
                
                totalInvestment += summary.totalInvestment;
                totalRealizedProfit += realizedProfit;
                totalFees += summary.totalFees;
                portfolioSummary.push(summary);
            });
            
            // å…¨ä½“çµ±è¨ˆ
            const portfolioStats = {
                totalInvestment,
                totalRealizedProfit,
                totalFees,
                overallProfitMargin: totalInvestment > 0 ? (totalRealizedProfit / totalInvestment) * 100 : 0,
                symbolCount: portfolioSummary.length,
                profitableSymbols: portfolioSummary.filter(s => s.realizedProfit > 0).length,
                lossSymbols: portfolioSummary.filter(s => s.realizedProfit < 0).length
            };
            
            return {
                summary: portfolioSummary,
                stats: portfolioStats,
                symbols: symbolData,
                lastUpdated: new Date().toISOString()
            };
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function showPage(pageId) {
            // å…¨ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // ãƒŠãƒ“ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.getElementById(`nav-${pageId}`).classList.add('active');
        }

        // ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹æ›´æ–°
        function updateDataStatus(portfolioData) {
            const statusElement = document.getElementById('data-status');
            const managementElement = document.getElementById('data-management');
            
            if (portfolioData && portfolioData.summary.length > 0) {
                const stats = portfolioData.stats;
                const profitColor = stats.totalRealizedProfit >= 0 ? '#27ae60' : '#e74c3c';
                const profitIcon = stats.totalRealizedProfit > 0 ? 'ğŸ“ˆ' : stats.totalRealizedProfit < 0 ? 'ğŸ“‰' : 'â–';
                
                statusElement.innerHTML = `
                    <div style="color: #27ae60; font-weight: 600;">âœ… ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š</div>
                    <div style="margin-top: 5px; font-size: 0.8rem;">
                        ${stats.symbolCount}éŠ˜æŸ„<br>
                        æŠ•è³‡é¡: Â¥${stats.totalInvestment.toLocaleString()}<br>
                        <span style="color: ${profitColor}; font-weight: 600;">
                            ${profitIcon} Â¥${Math.round(stats.totalRealizedProfit).toLocaleString()}
                        </span>
                    </div>
                `;
                managementElement.style.display = 'block';
            } else {
                statusElement.innerHTML = `<div style="color: #7f8c8d;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>`;
                managementElement.style.display = 'none';
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('portfolioData');
                localStorage.removeItem('rawTransactions');
                
                // UIåˆæœŸçŠ¶æ…‹ã«æˆ»ã™
                document.getElementById('dashboardArea').style.display = 'block';
                document.getElementById('tabContainer').style.display = 'none';
                updateDataStatus(null);
                
                showSuccessMessage('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                console.log('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchTab(tabName) {
            // å…¨ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ã‚µãƒ–ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchSubtab(subtabName) {
            // å…¨ã‚µãƒ–ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.subtab-button').forEach(btn => {
                btn.classList.remove('active');
                // ãƒœã‚¿ãƒ³ã®èƒŒæ™¯è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
                if (!btn.classList.contains('active')) {
                    btn.style.backgroundColor = '';
                }
            });
            document.querySelectorAll('.subtab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚µãƒ–ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            const targetButton = document.getElementById(`subtab-${subtabName}`);
            const targetContent = document.getElementById(`subtab-content-${subtabName}`);
            
            if (targetButton) {
                targetButton.classList.add('active');
                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã®èƒŒæ™¯è‰²ã‚’è¨­å®š
                targetButton.style.backgroundColor = '';
            }
            if (targetContent) {
                targetContent.classList.add('active');
                
                // éŠ˜æŸ„ã‚¿ãƒ–ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»ï¼ˆsummaryã¯é™¤å¤–ï¼‰
                if (subtabName !== 'summary') {
                    setTimeout(() => displaySymbolChart(subtabName.toUpperCase()), 100);
                }
            }
        }

        // éŠ˜æŸ„åˆ¥ã‚µãƒ–ã‚¿ãƒ–ç”Ÿæˆï¼ˆå¾©æ´»ç‰ˆï¼‰
        function createSymbolSubtabs(portfolioData) {
            const subtabNav = document.getElementById('subtab-nav');
            const symbolContainer = document.getElementById('symbol-subtabs-container');
            
            // æ—¢å­˜ã®éŠ˜æŸ„ã‚µãƒ–ã‚¿ãƒ–ã‚’ã‚¯ãƒªã‚¢
            subtabNav.querySelectorAll('.symbol-subtab').forEach(tab => tab.remove());
            symbolContainer.innerHTML = '';
            
            // éŠ˜æŸ„åˆ¥ã‚µãƒ–ã‚¿ãƒ–ã‚’ç”Ÿæˆ
            if (portfolioData && portfolioData.summary) {
                // å®Ÿç¾æç›Šã§é™é †ã‚½ãƒ¼ãƒˆ
                const sortedSymbols = [...portfolioData.summary].sort((a, b) => b.realizedProfit - a.realizedProfit);
                
                sortedSymbols.forEach(symbolData => {
                    // ã‚µãƒ–ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
                    const tabButton = document.createElement('button');
                    tabButton.className = 'subtab-button symbol-subtab';
                    tabButton.id = `subtab-${symbolData.symbol.toLowerCase()}`;
                    tabButton.textContent = symbolData.symbol;
                    tabButton.onclick = () => switchSubtab(symbolData.symbol.toLowerCase());
                    
                    // æç›Šã«å¿œã˜ã¦è‰²åˆ†ã‘ï¼ˆéé¸æŠæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
                    if (symbolData.realizedProfit > 0) {
                        tabButton.style.borderColor = '#28a745';
                        tabButton.style.color = '#28a745';
                    } else if (symbolData.realizedProfit < 0) {
                        tabButton.style.borderColor = '#dc3545';
                        tabButton.style.color = '#dc3545';
                    }
                    
                    // ãƒ›ãƒãƒ¼åŠ¹æœã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
                    tabButton.addEventListener('mouseenter', function() {
                        if (!this.classList.contains('active')) {
                            this.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                        }
                    });
                    
                    tabButton.addEventListener('mouseleave', function() {
                        if (!this.classList.contains('active')) {
                            this.style.backgroundColor = '';
                        }
                    });
                    
                    subtabNav.appendChild(tabButton);
                    
                    // ã‚µãƒ–ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ
                    const tabContent = document.createElement('div');
                    tabContent.className = 'subtab-content';
                    tabContent.id = `subtab-content-${symbolData.symbol.toLowerCase()}`;
                    tabContent.innerHTML = generateSymbolDetailPage(symbolData, portfolioData.symbols[symbolData.symbol]);
                    
                    symbolContainer.appendChild(tabContent);
                });
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆã‚½ãƒ¼ãƒˆç”¨ï¼‰
        let currentPortfolioData = null;
        let currentSortField = 'realizedProfit';
        let currentSortDirection = 'desc';

        // ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿é–¢é€£
        let currentPrices = {};
        let lastPriceUpdate = null;

        // éŠ˜æŸ„ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆCoinGecko APIç”¨ï¼‰
        const SYMBOL_MAPPING = {
            'BTC': 'bitcoin',
            'ETH': 'ethereum', 
            'SOL': 'solana',
            'XRP': 'ripple',
            'ADA': 'cardano',
            'DOGE': 'dogecoin',
            'ASTR': 'astar',
            'XTZ': 'tezos',
            'XLM': 'stellar',
            'SHIB': 'shiba-inu',
            'PEPE': 'pepe',
            'SUI': 'sui',
            'DAI': 'dai'
        };

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ ç‰ˆï¼‰
        function displayDashboard(portfolioData) {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            currentPortfolioData = portfolioData;
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚½ãƒ¼ãƒˆï¼ˆå®Ÿç¾æç›Šé™é †ï¼‰
            sortPortfolioData('realizedProfit', 'desc');
            
            // æ—§è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            document.getElementById('dashboardArea').style.display = 'none';
            
            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
            document.getElementById('tabContainer').style.display = 'block';
            
            // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼ã‚¨ãƒªã‚¢ã¯å‰Šé™¤æ¸ˆã¿
            
            // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
            const tableContainer = document.getElementById('portfolio-table-container');
            tableContainer.innerHTML = generatePortfolioTable(currentPortfolioData);
            
            // ä¿å­˜æ¸ˆã¿ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            if (loadSavedPrices()) {
                // ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã§ããŸå ´åˆã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
                tableContainer.innerHTML = generatePortfolioTable(currentPortfolioData);
                updatePriceStatus();
            } else {
                updatePriceStatus('ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // å–å¼•å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
            const tradingContainer = document.getElementById('trading-history-container');
            tradingContainer.innerHTML = generateTradingHistoryTable(portfolioData);
            
            // éŠ˜æŸ„åˆ¥ã‚µãƒ–ã‚¿ãƒ–ä½œæˆ
            createSymbolSubtabs(portfolioData);
            
            // ã‚µãƒãƒªãƒ¼ã‚¿ãƒ–ã‚’æ˜ç¤ºçš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«è¨­å®š
            switchSubtab('summary');
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚¿ãƒ–åˆæœŸåŒ–
            initializeChartTab();
            
            updateDataStatus(portfolioData);
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸå¾Œã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã«åˆ‡ã‚Šæ›¿ãˆ
            showPage('dashboard');
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
        function sortTable(field) {
            if (!currentPortfolioData) return;
            
            // åŒã˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯æ–¹å‘ã‚’é€†è»¢
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã¯é™é †ã‹ã‚‰é–‹å§‹
                currentSortField = field;
                currentSortDirection = 'desc';
            }
            
            sortPortfolioData(field, currentSortDirection);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»
            const tableContainer = document.getElementById('portfolio-table-container');
            tableContainer.innerHTML = generatePortfolioTable(currentPortfolioData);
            
            console.log(`ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ: ${field} ${currentSortDirection}`);
        }

        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ãƒˆ
        function sortPortfolioData(field, direction) {
            if (!currentPortfolioData || !currentPortfolioData.summary) return;
            
            currentPortfolioData.summary.sort((a, b) => {
                let aVal, bVal;
                
                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤å–å¾—
                switch(field) {
                    case 'symbol':
                        aVal = a.symbol;
                        bVal = b.symbol;
                        break;
                    case 'averagePurchaseRate':
                        aVal = a.averagePurchaseRate;
                        bVal = b.averagePurchaseRate;
                        break;
                    case 'totalInvestment':
                        aVal = a.totalInvestment;
                        bVal = b.totalInvestment;
                        break;
                    case 'heldInvestment':
                        aVal = a.currentHoldingInvestment;
                        bVal = b.currentHoldingInvestment;
                        break;
                    case 'currentPrice':
                        aVal = a.currentPrice || 0;
                        bVal = b.currentPrice || 0;
                        break;
                    case 'currentValue':
                        aVal = a.currentValue || 0;
                        bVal = b.currentValue || 0;
                        break;
                    case 'realizedProfit':
                        aVal = a.realizedProfit;
                        bVal = b.realizedProfit;
                        break;
                    case 'unrealizedProfit':
                        aVal = a.unrealizedProfit || 0;
                        bVal = b.unrealizedProfit || 0;
                        break;
                    case 'totalProfit':
                        aVal = a.totalProfit || a.realizedProfit;
                        bVal = b.totalProfit || b.realizedProfit;
                        break;
                    default:
                        return 0;
                }
                
                // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
                if (field === 'symbol') {
                    // æ–‡å­—åˆ—ã‚½ãƒ¼ãƒˆ
                    if (direction === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                } else {
                    // æ•°å€¤ã‚½ãƒ¼ãƒˆ
                    if (direction === 'asc') {
                        return aVal - bVal;
                    } else {
                        return bVal - aVal;
                    }
                }
            });
            
            updateSortIndicators(field, direction);
        }

        // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³å–å¾—
        function getSortIcon(field) {
            if (currentSortField === field) {
                return currentSortDirection === 'asc' ? 'â–²' : 'â–¼';
            }
            return '';
        }

        // ã‚½ãƒ¼ãƒˆæ–¹å‘è¡¨ç¤ºæ›´æ–°
        function updateSortIndicators(activeField, direction) {
            const fields = ['symbol', 'holdingQuantity', 'averagePurchaseRate', 'totalInvestment', 
                           'currentPrice', 'currentValue', 'totalSellAmount', 'realizedProfit', 
                           'unrealizedProfit', 'realizedProfit', 'totalProfit'];
            
            fields.forEach(field => {
                const indicator = document.getElementById(`sort-${field}`);
                if (indicator) {
                    if (field === activeField) {
                        indicator.textContent = direction === 'asc' ? 'â–²' : 'â–¼';
                        indicator.style.color = '#3498db';
                    } else {
                        indicator.textContent = '';
                        indicator.style.color = '';
                    }
                }
            });
        }

        // ä¾¡æ ¼å–å¾—é–¢é€£æ©Ÿèƒ½
        async function fetchCurrentPrices() {
            try {
                console.log('ä¾¡æ ¼å–å¾—é–‹å§‹', currentPortfolioData);
                
                if (!currentPortfolioData || !currentPortfolioData.summary) {
                    throw new Error('ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                // å¯¾å¿œéŠ˜æŸ„ã®CoinGecko IDã‚’å–å¾—
                const portfolioSymbols = currentPortfolioData.summary.map(item => item.symbol);
                const validSymbols = portfolioSymbols.filter(symbol => SYMBOL_MAPPING[symbol]);
                
                console.log('ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªéŠ˜æŸ„:', portfolioSymbols);
                console.log('å¯¾å¿œéŠ˜æŸ„:', validSymbols);
                
                if (validSymbols.length === 0) {
                    throw new Error('å¯¾å¿œéŠ˜æŸ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                const coingeckoIds = validSymbols.map(symbol => SYMBOL_MAPPING[symbol]).join(',');
                const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coingeckoIds}&vs_currencies=jpy&include_last_updated_at=true`;
                
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('CoinGecko APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
                const prices = {};
                for (const symbol of validSymbols) {
                    const coingeckoId = SYMBOL_MAPPING[symbol];
                    if (data[coingeckoId]) {
                        prices[symbol] = {
                            price_jpy: data[coingeckoId].jpy,
                            last_updated: data[coingeckoId].last_updated_at
                        };
                        console.log(`${symbol} (${coingeckoId}): Â¥${data[coingeckoId].jpy}`);
                    }
                }
                console.log('æ•´ç†ã•ã‚ŒãŸä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿:', prices);
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                currentPrices = prices;
                lastPriceUpdate = new Date();
                
                // localStorage ã«ä¿å­˜
                localStorage.setItem('currentPrices', JSON.stringify(prices));
                localStorage.setItem('lastPriceUpdate', lastPriceUpdate.toISOString());
                
                // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’å†è¨ˆç®—ï¼ˆå«ã¿æç›Šå«ã‚€ï¼‰
                updatePortfolioWithPrices(currentPortfolioData, prices);
                
                // ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆé †ã‚’ç¶­æŒã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»
                sortPortfolioData(currentSortField, currentSortDirection);
                const tableContainer = document.getElementById('portfolio-table-container');
                tableContainer.innerHTML = generatePortfolioTable(currentPortfolioData);
                
                showSuccessMessage(`ä¾¡æ ¼æ›´æ–°å®Œäº†: ${validSymbols.length}éŠ˜æŸ„`);
                updatePriceStatus();
                
            } catch (error) {
                console.error('ä¾¡æ ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showErrorMessage(`ä¾¡æ ¼å–å¾—å¤±æ•—: ${error.message}`);
                updatePriceStatus('å–å¾—å¤±æ•—');
            }
        }

        // ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’æ›´æ–°ï¼ˆå«ã¿æç›Šè¨ˆç®—ï¼‰
        function updatePortfolioWithPrices(portfolioData, prices) {
            let totalUnrealizedProfit = 0;
            
            portfolioData.summary.forEach(item => {
                if (prices[item.symbol] && item.holdingQuantity > 0) {
                    const currentPrice = prices[item.symbol].price_jpy;
                    const currentValue = item.holdingQuantity * currentPrice;
                    // ç¾åœ¨ä¿æœ‰åˆ†ã®æŠ•è³‡é¡ = ä¿æœ‰æ•°é‡ Ã— å¹³å‡è³¼å…¥ãƒ¬ãƒ¼ãƒˆ
                    const currentHoldingCost = item.holdingQuantity * item.averagePurchaseRate;
                    const unrealizedProfit = currentValue - currentHoldingCost;
                    
                    // å«ã¿æç›Šã‚’è¿½åŠ 
                    item.currentPrice = currentPrice;
                    item.currentValue = currentValue;
                    item.unrealizedProfit = unrealizedProfit;
                    item.totalProfit = item.realizedProfit + unrealizedProfit;
                    
                    totalUnrealizedProfit += unrealizedProfit;
                } else {
                    // ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¼ãƒ­ã§åˆæœŸåŒ–
                    item.currentPrice = 0;
                    item.currentValue = 0;
                    item.unrealizedProfit = 0;
                    item.totalProfit = item.realizedProfit;
                }
            });
            
            // çµ±è¨ˆã«å«ã¿æç›Šã‚’è¿½åŠ 
            portfolioData.stats.totalUnrealizedProfit = totalUnrealizedProfit;
            portfolioData.stats.totalProfit = portfolioData.stats.totalRealizedProfit + totalUnrealizedProfit;
            
            console.log('ä¾¡æ ¼æ›´æ–°å¾Œçµ±è¨ˆ:');
            console.log('å®Ÿç¾æç›Š:', portfolioData.stats.totalRealizedProfit);
            console.log('å«ã¿æç›Š:', totalUnrealizedProfit);
            console.log('ç·åˆæç›Š:', portfolioData.stats.totalProfit);
        }

        // ä¿å­˜æ¸ˆã¿ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        function loadSavedPrices() {
            try {
                const savedPrices = localStorage.getItem('currentPrices');
                const savedUpdate = localStorage.getItem('lastPriceUpdate');
                
                if (savedPrices && savedUpdate) {
                    currentPrices = JSON.parse(savedPrices);
                    lastPriceUpdate = new Date(savedUpdate);
                    
                    // 1æ™‚é–“ä»¥å†…ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    if (lastPriceUpdate > oneHourAgo) {
                        updatePortfolioWithPrices(currentPortfolioData, currentPrices);
                        return true;
                    }
                }
            } catch (error) {
                console.error('ä¿å­˜æ¸ˆã¿ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
            return false;
        }

        // ä¾¡æ ¼æ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function updatePriceStatus(message = null) {
            const statusElement = document.getElementById('price-update-status');
            if (!statusElement) return;
            
            if (message) {
                statusElement.textContent = message;
                return;
            }
            
            if (lastPriceUpdate) {
                const symbols = Object.keys(currentPrices).length;
                const timeStr = lastPriceUpdate.toLocaleString('ja-JP');
                statusElement.textContent = `${symbols}éŠ˜æŸ„ | ${timeStr}`;
                statusElement.style.color = '#28a745';
            } else {
                statusElement.textContent = 'ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ãªã—';
                statusElement.style.color = '#6c757d';
            }
        }

        // Chart.jsé–¢é€£æ©Ÿèƒ½
        let priceChart = null;
        let historicalData = {};

        // ãƒãƒ£ãƒ¼ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateDummyChartData(symbol) {
            const data = [];
            const basePrice = symbol === 'BTC' ? 4000000 : symbol === 'ETH' ? 300000 : 100000;
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30); // 30æ—¥å‰ã‹ã‚‰

            for (let i = 0; i < 30; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const variance = (Math.random() - 0.5) * 0.1; // Â±10%ã®å¤‰å‹•
                const price = basePrice * (1 + variance);
                
                data.push({
                    x: date.getTime(), // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å½¢å¼ã«å¤‰æ›´
                    y: Math.round(price)
                });
            }
            return data;
        }

        // éŠ˜æŸ„é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆè‡ªå‹•å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
        async function onSymbolSelect() {
            const select = document.getElementById('chart-symbol-select');
            if (!select) return;
            
            const selectedSymbol = select.value;
            
            if (!selectedSymbol) {
                // éŠ˜æŸ„ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒãƒ£ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
                if (priceChart) {
                    priceChart.destroy();
                    priceChart = null;
                }
                return;
            }

            // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯è‡ªå‹•å–å¾—
            if (!historicalData[selectedSymbol]) {
                await fetchHistoricalDataForSymbol(selectedSymbol);
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
            loadPriceChart();
        }


        // ETHãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³
        function selectETHChart() {
            const select = document.getElementById('chart-symbol-select');
            if (select) {
                select.value = 'ETH';
                onSymbolSelect();
            }
        }

        // éŠ˜æŸ„åˆ¥ãƒãƒ£ãƒ¼ãƒˆæç”»
        function displaySymbolChart(symbol) {
            const canvas = document.getElementById(`${symbol.toLowerCase()}-chart-canvas`);
            if (!canvas) {
                console.log(`${symbol}ãƒãƒ£ãƒ¼ãƒˆcanvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å‰Šé™¤
            const chartKey = `${symbol.toLowerCase()}TabChart`;
            if (window[chartKey]) {
                window[chartKey].destroy();
            }

            // ãƒ‡ãƒ¼ã‚¿æº–å‚™
            let chartData = [];
            if (historicalData[symbol] && Array.isArray(historicalData[symbol])) {
                chartData = historicalData[symbol];
            } else {
                chartData = generateDummyChartData(symbol);
            }
            
            if (!chartData || chartData.length === 0) {
                chartData = generateDummyChartData(symbol);
            }

            // éŠ˜æŸ„åˆ¥ã®è‰²è¨­å®š
            const colors = {
                'BTC': { border: '#F7931A', bg: 'rgba(247, 147, 26, 0.1)' },
                'ETH': { border: '#627EEA', bg: 'rgba(98, 126, 234, 0.1)' },
                'SOL': { border: '#9945FF', bg: 'rgba(153, 69, 255, 0.1)' },
                'XRP': { border: '#23292F', bg: 'rgba(35, 41, 47, 0.1)' },
                'ADA': { border: '#0033AD', bg: 'rgba(0, 51, 173, 0.1)' },
                'DOGE': { border: '#C2A633', bg: 'rgba(194, 166, 51, 0.1)' },
                'ASTR': { border: '#0070F3', bg: 'rgba(0, 112, 243, 0.1)' },
                'XTZ': { border: '#2C7DF7', bg: 'rgba(44, 125, 247, 0.1)' },
                'XLM': { border: '#14B6E7', bg: 'rgba(20, 182, 231, 0.1)' },
                'SHIB': { border: '#FFA409', bg: 'rgba(255, 164, 9, 0.1)' },
                'PEPE': { border: '#00D924', bg: 'rgba(0, 217, 36, 0.1)' },
                'SUI': { border: '#4DA2FF', bg: 'rgba(77, 162, 255, 0.1)' },
                'DAI': { border: '#FBCC5F', bg: 'rgba(251, 204, 95, 0.1)' }
            };
            
            const color = colors[symbol] || { border: '#3498db', bg: 'rgba(52, 152, 219, 0.1)' };

            // ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            window[chartKey] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${symbol} ä¾¡æ ¼ (JPY)`,
                        data: chartData,
                        borderColor: color.border,
                        backgroundColor: color.bg,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 2,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MM/dd'
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            console.log(`${symbol}ãƒãƒ£ãƒ¼ãƒˆæç”»å®Œäº†`);
            
            // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã¾ã ãªã„å ´åˆï¼‰
            if (!historicalData[symbol]) {
                fetchSymbolHistoricalData(symbol);
            }
        }

        // éŠ˜æŸ„åˆ¥å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function fetchSymbolHistoricalData(symbol) {
            const coingeckoId = SYMBOL_MAPPING[symbol];
            if (!coingeckoId) {
                console.log(`${symbol}ã®CoinGecko ID ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                return;
            }

            try {
                const url = `https://api.coingecko.com/api/v3/coins/${coingeckoId}/market_chart?vs_currency=jpy&days=30`;
                console.log(`${symbol}å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.prices) {
                    const chartData = data.prices.map(([timestamp, price]) => ({
                        x: new Date(timestamp),
                        y: Math.round(price)
                    }));
                    
                    historicalData[symbol] = chartData;
                    console.log(`${symbol}å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${chartData.length}ä»¶`);
                    
                    // ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
                    displaySymbolChart(symbol);
                }
            } catch (error) {
                console.error(`${symbol}å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
            }
        }

        // ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
        function loadPriceChart() {
            const select = document.getElementById('chart-symbol-select');
            if (!select) return;
            
            const selectedSymbol = select.value;
            
            if (!selectedSymbol) {
                if (priceChart) {
                    priceChart.destroy();
                    priceChart = null;
                }
                return;
            }

            const canvas = document.getElementById('price-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å‰Šé™¤
            if (priceChart) {
                priceChart.destroy();
            }

            // ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆã¾ãšã¯ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰
            let chartData = [];
            if (historicalData[selectedSymbol] && Array.isArray(historicalData[selectedSymbol])) {
                chartData = historicalData[selectedSymbol];
            } else {
                chartData = generateDummyChartData(selectedSymbol);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (!chartData || chartData.length === 0) {
                chartData = generateDummyChartData(selectedSymbol);
            }

            // ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${selectedSymbol} ä¾¡æ ¼ (JPY)`,
                        data: chartData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 2,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${selectedSymbol} ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ`
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'M/d'
                                }
                            },
                            title: {
                                display: true,
                                text: 'æ—¥ä»˜'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ä¾¡æ ¼ (JPY)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç‰¹å®šéŠ˜æŸ„ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå†…éƒ¨ç”¨ï¼‰
        async function fetchHistoricalDataForSymbol(symbol) {
            const coingeckoId = SYMBOL_MAPPING[symbol];
            if (!coingeckoId) {
                console.error(`å¯¾å¿œã—ã¦ã„ãªã„éŠ˜æŸ„: ${symbol}`);
                return false;
            }

            try {
                console.log(`å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹: ${symbol}`);
                
                // 30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const url = `https://api.coingecko.com/api/v3/coins/${coingeckoId}/market_chart?vs_currency=jpy&days=30`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
                const chartData = data.prices.map(([timestamp, price]) => ({
                    x: timestamp,
                    y: Math.round(price)
                }));
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                historicalData[symbol] = chartData;
                
                console.log(`å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${symbol} (${chartData.length}ä»¶)`);
                return true;
                
            } catch (error) {
                console.error(`å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ (${symbol}):`, error);
                return false;
            }
        }

        // å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆCoinGecko APIï¼‰- æ‰‹å‹•å®Ÿè¡Œç”¨ï¼ˆéæ¨å¥¨ï¼‰
        async function fetchHistoricalData() {
            const select = document.getElementById('chart-symbol-select');
            const selectedSymbol = select.value;
            
            if (!selectedSymbol) {
                showErrorMessage('éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const success = await fetchHistoricalDataForSymbol(selectedSymbol);
            
            if (success) {
                loadPriceChart();
                showSuccessMessage(`${selectedSymbol}ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
            } else {
                showErrorMessage(`${selectedSymbol}ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒãƒ£ãƒ¼ãƒˆã‚¿ãƒ–ã®åˆæœŸåŒ–ï¼ˆéŠ˜æŸ„é¸æŠè‚¢ã‚’è¨­å®šï¼‰
        function initializeChartTab() {
            const select = document.getElementById('chart-symbol-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- éŠ˜æŸ„ã‚’é¸æŠ --</option>';
            
            if (currentPortfolioData && currentPortfolioData.summary && Array.isArray(currentPortfolioData.summary)) {
                currentPortfolioData.summary.forEach(item => {
                    if (item && item.symbol && SYMBOL_MAPPING[item.symbol]) {
                        const option = document.createElement('option');
                        option.value = item.symbol;
                        option.textContent = item.symbol;
                        select.appendChild(option);
                    }
                });
            }
        }

        // ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆï¼ˆæç›Šè¨ˆç®—ç‰ˆï¼‰
        function generatePortfolioTable(portfolioData) {
            const stats = portfolioData.stats;
            const profitColor = stats.totalRealizedProfit >= 0 ? '#27ae60' : '#e74c3c';
            
            let html = `
                <!-- ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼ -->
                <div style="margin-bottom: 25px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1e293b;">ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µãƒãƒªãƒ¼ï¼ˆ${stats.symbolCount}éŠ˜æŸ„ï¼‰</h3>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                        <!-- ç·åˆæç›Šï¼ˆæœ€å„ªå…ˆè¡¨ç¤ºï¼‰ -->
                        <div style="text-align: center; padding: 12px; background: ${(stats.totalProfit || stats.totalRealizedProfit) >= 0 ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'}; border-radius: 8px; border: 2px solid ${(stats.totalProfit || stats.totalRealizedProfit) >= 0 ? '#10b981' : '#ef4444'};">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 600;">ç·åˆæç›Š</div>
                            <div style="font-size: 18px; font-weight: 800; color: ${(stats.totalProfit || stats.totalRealizedProfit) >= 0 ? '#059669' : '#dc2626'};">${(stats.totalProfit || stats.totalRealizedProfit) >= 0 ? '+' : ''}Â¥${Math.round(stats.totalProfit || stats.totalRealizedProfit).toLocaleString()}</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 2px; font-weight: 600;">${stats.overallProfitMargin >= 0 ? '+' : ''}${stats.overallProfitMargin.toFixed(1)}%</div>
                        </div>
                        
                        <!-- æŠ•è³‡é¡ -->
                        <div style="text-align: center; padding: 12px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">æŠ•è³‡é¡</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">Â¥${Math.abs(stats.totalInvestment).toLocaleString()}</div>
                        </div>
                        
                        <!-- å®Ÿç¾æç›Š -->
                        <div style="text-align: center; padding: 12px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid ${stats.totalRealizedProfit >= 0 ? '#10b981' : '#ef4444'};">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">å®Ÿç¾æç›Š</div>
                            <div style="font-size: 16px; font-weight: 700; color: ${stats.totalRealizedProfit >= 0 ? '#059669' : '#dc2626'};">${stats.totalRealizedProfit >= 0 ? '+' : ''}Â¥${Math.round(stats.totalRealizedProfit).toLocaleString()}</div>
                        </div>
                        
                        <!-- å«ã¿æç›Š -->
                        <div style="text-align: center; padding: 12px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid ${(stats.totalUnrealizedProfit || 0) >= 0 ? '#10b981' : '#ef4444'};">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">å«ã¿æç›Š</div>
                            <div style="font-size: 16px; font-weight: 700; color: ${(stats.totalUnrealizedProfit || 0) >= 0 ? '#059669' : '#dc2626'};">${(stats.totalUnrealizedProfit || 0) >= 0 ? '+' : ''}Â¥${Math.round(stats.totalUnrealizedProfit || 0).toLocaleString()}</div>
                        </div>
                        
                        <!-- æ‰‹æ•°æ–™ -->
                        <div style="text-align: center; padding: 12px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #64748b;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">æ‰‹æ•°æ–™</div>
                            <div style="font-size: 16px; font-weight: 700; color: #475569;">Â¥${stats.totalFees.toLocaleString()}</div>
                        </div>
                    </div>
                </div>

                <!-- éŠ˜æŸ„åˆ¥è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; margin-bottom: 30px; width: 100%; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white;">
                    <thead>
                        <tr style="background-color: #e8f5e8;">
                            <th onclick="sortTable('symbol')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: left; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">éŠ˜æŸ„ <span id="sort-symbol">${getSortIcon('symbol')}</span></th>
                            <th onclick="sortTable('currentPrice')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">ç¾åœ¨ä¾¡æ ¼ <span id="sort-currentPrice">${getSortIcon('currentPrice')}</span></th>
                            <th onclick="sortTable('averagePurchaseRate')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">å¹³å‡è³¼å…¥ãƒ¬ãƒ¼ãƒˆ <span id="sort-averagePurchaseRate">${getSortIcon('averagePurchaseRate')}</span></th>
                            <th onclick="sortTable('currentValue')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">è©•ä¾¡é¡ <span id="sort-currentValue">${getSortIcon('currentValue')}</span></th>
                            <th onclick="sortTable('heldInvestment')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">ä¿æœ‰åˆ†è³¼å…¥é¡ <span id="sort-heldInvestment">${getSortIcon('heldInvestment')}</span></th>
                            <th onclick="sortTable('totalInvestment')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">åˆè¨ˆè³¼å…¥é¡ <span id="sort-totalInvestment">${getSortIcon('totalInvestment')}</span></th>
                            <th onclick="sortTable('unrealizedProfit')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">å«ã¿æç›Š <span id="sort-unrealizedProfit">${getSortIcon('unrealizedProfit')}</span></th>
                            <th onclick="sortTable('realizedProfit')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">å®Ÿç¾æç›Š <span id="sort-realizedProfit" style="color: #3498db;">${getSortIcon('realizedProfit')}</span></th>
                            <th onclick="sortTable('totalProfit')" style="cursor: pointer; user-select: none; position: relative; padding: 15px 12px; text-align: right; font-weight: 600; font-size: 0.9rem; color: #2c3e50;">ç·åˆæç›Š <span id="sort-totalProfit">${getSortIcon('totalProfit')}</span></th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            portfolioData.summary.forEach(item => {
                const profitColor = item.realizedProfit > 0 ? '#27ae60' : item.realizedProfit < 0 ? '#e74c3c' : '#6c757d';
                const profitBg = item.realizedProfit > 0 ? 'rgba(39, 174, 96, 0.05)' : item.realizedProfit < 0 ? 'rgba(231, 76, 60, 0.05)' : '';
                
                html += `
                    <tr style="transition: all 0.2s ease; ${profitBg ? `background-color: ${profitBg};` : ''}" onmouseover="this.style.backgroundColor='rgba(74, 144, 226, 0.08)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.backgroundColor='${profitBg}'; this.style.transform=''">
                        <td style="padding: 12px; font-weight: bold; color: #2196F3; border-bottom: 1px solid #f1f3f4;">${item.symbol}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem;">${item.currentPrice > 0 ? 'Â¥' + item.currentPrice.toLocaleString() : '-'}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem;">Â¥${item.averagePurchaseRate.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem;">${item.currentValue > 0 ? 'Â¥' + item.currentValue.toLocaleString() : '-'}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem;">Â¥${item.currentHoldingInvestment.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem;">Â¥${item.totalInvestment.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem; color: ${(item.unrealizedProfit || 0) >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: ${Math.abs(item.unrealizedProfit || 0) > 0 ? 'bold' : 'normal'};">${(item.unrealizedProfit || 0) !== 0 ? 'Â¥' + Math.round(item.unrealizedProfit || 0).toLocaleString() : '-'}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem; color: ${profitColor}; font-weight: ${Math.abs(item.realizedProfit) > 0 ? 'bold' : 'normal'};">${item.realizedProfit !== 0 ? 'Â¥' + Math.round(item.realizedProfit).toLocaleString() : '-'}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f1f3f4; font-size: 0.9rem; color: ${(item.totalProfit || item.realizedProfit) >= 0 ? '#27ae60' : '#e74c3c'}; font-weight: ${Math.abs(item.totalProfit || item.realizedProfit) > 0 ? 'bold' : 'normal'};">${(item.totalProfit || item.realizedProfit) !== 0 ? 'Â¥' + Math.round(item.totalProfit || item.realizedProfit).toLocaleString() : '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            return html;
        }

        // å–å¼•å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
        function generateTradingHistoryTable(portfolioData) {
            const allTransactions = [];
            Object.values(portfolioData.symbols).forEach(symbolData => {
                allTransactions.push(...symbolData.buyTransactions, ...symbolData.sellTransactions);
            });
            
            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <div style="background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c3e50; margin-bottom: 20px;">å…¨å–å¼•å±¥æ­´ï¼ˆæ–°ã—ã„é †ï¼‰</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: 600; color: #495057;">æ—¥æ™‚</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: 600; color: #495057;">éŠ˜æŸ„</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: 600; color: #495057;">å£²è²·</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: 600; color: #495057;">æ•°é‡</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: 600; color: #495057;">ãƒ¬ãƒ¼ãƒˆ</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: 600; color: #495057;">é‡‘é¡</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: 600; color: #495057;">å–å¼•æ‰€</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            allTransactions.slice(0, 50).forEach(tx => { // æœ€æ–°50ä»¶ã®ã¿è¡¨ç¤º
                const typeColor = tx.type === 'è²·' ? '#28a745' : '#dc3545';
                html += `
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 12px; font-size: 0.9rem;">${new Date(tx.date).toLocaleString('ja-JP')}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; font-weight: bold;">${tx.symbol}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: center; color: ${typeColor}; font-weight: bold;">${tx.type}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">${tx.quantity.toFixed(8)}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">Â¥${tx.rate.toLocaleString()}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">Â¥${tx.amount.toLocaleString()}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-size: 0.85rem;">${tx.exchange}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    ${allTransactions.length > 50 ? `<p style="color: #7f8c8d; text-align: center; margin-top: 15px;">â€»æœ€æ–°50ä»¶ã®ã¿è¡¨ç¤ºï¼ˆå…¨${allTransactions.length}ä»¶ï¼‰</p>` : ''}
                </div>
            `;
            return html;
        }

        // å€‹åˆ¥éŠ˜æŸ„è©³ç´°ãƒšãƒ¼ã‚¸ç”Ÿæˆ
        function generateSymbolDetailPage(symbolSummary, symbolData) {
            const profitColor = symbolSummary.realizedProfit >= 0 ? '#27ae60' : '#e74c3c';
            const profitIcon = symbolSummary.realizedProfit > 0 ? 'ğŸ“ˆ' : symbolSummary.realizedProfit < 0 ? 'ğŸ“‰' : 'â–';
            
            let html = `
                <!-- éŠ˜æŸ„ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 24px; font-weight: 700; color: #1e293b;">${symbolSummary.symbol} è©³ç´°åˆ†æ</h3>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #64748b;">å€‹åˆ¥éŠ˜æŸ„ã®å–å¼•å±¥æ­´ãƒ»çµ±è¨ˆãƒ»æç›Šåˆ†æ</p>
                    </div>
                    
                    <!-- æç›Šã‚«ãƒ¼ãƒ‰ï¼ˆ1è¡Œç›®ï¼‰ -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                        <!-- ç·åˆæç›Š -->
                        <div style="text-align: center; padding: 15px; background: ${symbolSummary.totalSellAmount === 0 ? 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)' : (symbolSummary.totalProfit || symbolSummary.realizedProfit) >= 0 ? 'linear-gradient(135deg, #d4f1d4 0%, #a8e6a8 100%)' : 'linear-gradient(135deg, #fcd4d4 0%, #f8a8a8 100%)'}; border-radius: 8px; border: 3px solid ${symbolSummary.totalSellAmount === 0 ? '#9ca3af' : (symbolSummary.totalProfit || symbolSummary.realizedProfit) >= 0 ? '#059669' : '#dc2626'};">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 700;">ç·åˆæç›Š</div>
                            <div style="font-size: 20px; font-weight: 900; color: ${symbolSummary.totalSellAmount === 0 ? '#6b7280' : (symbolSummary.totalProfit || symbolSummary.realizedProfit) >= 0 ? '#047857' : '#b91c1c'};">${symbolSummary.totalSellAmount === 0 ? 'â³ ' : profitIcon + ' '}${symbolSummary.totalSellAmount === 0 ? 'æœªç¢ºå®š' : ((symbolSummary.totalProfit || symbolSummary.realizedProfit) >= 0 ? '+' : '') + 'Â¥' + Math.round(symbolSummary.totalProfit || symbolSummary.realizedProfit).toLocaleString()}</div>
                        </div>
                        
                        <!-- å®Ÿç¾æç›Š -->
                        <div style="text-align: center; padding: 15px; background: ${symbolSummary.totalSellAmount === 0 ? 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)' : symbolSummary.realizedProfit >= 0 ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'}; border-radius: 8px; border: 2px solid ${symbolSummary.totalSellAmount === 0 ? '#9ca3af' : symbolSummary.realizedProfit >= 0 ? '#10b981' : '#ef4444'};">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 600;">å®Ÿç¾æç›Š</div>
                            <div style="font-size: 18px; font-weight: 800; color: ${symbolSummary.totalSellAmount === 0 ? '#6b7280' : symbolSummary.realizedProfit >= 0 ? '#059669' : '#dc2626'};">${symbolSummary.totalSellAmount === 0 ? 'â³ æœªç¢ºå®š' : (symbolSummary.realizedProfit >= 0 ? '+' : '') + 'Â¥' + Math.round(symbolSummary.realizedProfit).toLocaleString()}</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 2px; font-weight: 600;">${symbolSummary.totalSellAmount === 0 ? '' : (symbolSummary.investmentEfficiency >= 0 ? '+' : '') + symbolSummary.investmentEfficiency.toFixed(1) + '%'}</div>
                        </div>
                        
                        <!-- å«ã¿æç›Š -->
                        <div style="text-align: center; padding: 15px; background: ${(symbolSummary.unrealizedProfit || 0) >= 0 ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)'}; border-radius: 8px; border: 2px solid ${(symbolSummary.unrealizedProfit || 0) >= 0 ? '#10b981' : '#ef4444'};">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 600;">å«ã¿æç›Š</div>
                            <div style="font-size: 18px; font-weight: 800; color: ${(symbolSummary.unrealizedProfit || 0) >= 0 ? '#059669' : '#dc2626'};">${(symbolSummary.unrealizedProfit || 0) >= 0 ? '+' : ''}Â¥${Math.round(symbolSummary.unrealizedProfit || 0).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°çµ±è¨ˆï¼ˆ2è¡Œç›®ï¼‰ -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px;">
                        <!-- ä¿æœ‰æ•°é‡ -->
                        <div style="text-align: center; padding: 15px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">ä¿æœ‰æ•°é‡</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">${parseFloat(symbolSummary.holdingQuantity.toFixed(8))}</div>
                        </div>
                        
                        <!-- å¹³å‡è³¼å…¥ãƒ¬ãƒ¼ãƒˆ -->
                        <div style="text-align: center; padding: 15px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">å¹³å‡è³¼å…¥ãƒ¬ãƒ¼ãƒˆ</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">Â¥${symbolSummary.averagePurchaseRate.toLocaleString()}</div>
                        </div>
                        
                        <!-- ç·æŠ•è³‡é¡ -->
                        <div style="text-align: center; padding: 15px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">ç·æŠ•è³‡é¡</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">Â¥${symbolSummary.totalInvestment.toLocaleString()}</div>
                        </div>
                        
                        <!-- å£²å´é‡‘é¡ -->
                        <div style="text-align: center; padding: 15px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #06b6d4;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">å£²å´é‡‘é¡</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">Â¥${symbolSummary.totalSellAmount.toLocaleString()}</div>
                        </div>
                        
                        <!-- å–å¼•å›æ•° -->
                        <div style="text-align: center; padding: 15px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #84cc16;">
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px; font-weight: 500;">å–å¼•å›æ•°</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b;">è²·${symbolSummary.buyTransactionCount}å›ãƒ»å£²${symbolSummary.sellTransactionCount}å›</div>
                        </div>
                    </div>
                </div>

                <!-- å–å¼•å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div style="background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c3e50; margin-bottom: 20px;">ğŸ“Š ${symbolSummary.symbol} å…¨å–å¼•å±¥æ­´ï¼ˆ${symbolData.allTransactions.length}ä»¶ï¼‰</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left; font-weight: 600; color: #495057;">æ—¥æ™‚</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: 600; color: #495057;">å£²è²·</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: 600; color: #495057;">æ•°é‡</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: 600; color: #495057;">ãƒ¬ãƒ¼ãƒˆ</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: 600; color: #495057;">é‡‘é¡</th>
                                    <th style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: 600; color: #495057;">å–å¼•æ‰€</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // å–å¼•å±¥æ­´ã‚’æ—¥ä»˜é †ã«ä¸¦ã³æ›¿ãˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedTransactions = [...symbolData.allTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedTransactions.forEach(tx => {
                const typeColor = tx.type === 'è²·' ? '#28a745' : '#dc3545';
                const typeBg = tx.type === 'è²·' ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';
                
                html += `
                    <tr style="background-color: ${typeBg};">
                        <td style="border: 1px solid #dee2e6; padding: 12px; font-size: 0.9rem;">${new Date(tx.date).toLocaleString('ja-JP')}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: center; color: ${typeColor}; font-weight: bold; font-size: 0.95rem;">${tx.type}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-family: monospace;">${parseFloat(tx.quantity.toFixed(8))}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-family: monospace;">Â¥${tx.rate.toLocaleString()}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-family: monospace; font-weight: 600;">Â¥${tx.amount.toLocaleString()}</td>
                        <td style="border: 1px solid #dee2e6; padding: 12px; text-align: center; font-size: 0.85rem; font-weight: 600;">${tx.exchange}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // å…¨éŠ˜æŸ„ã«ãƒãƒ£ãƒ¼ãƒˆã‚’è¿½åŠ 
            html += `
                <!-- ${symbolSummary.symbol}ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ -->
                <div style="background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 20px;">ğŸ“ˆ ${symbolSummary.symbol} ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆ30æ—¥é–“ï¼‰</h4>
                    <div id="${symbolSummary.symbol.toLowerCase()}-chart-container" style="position: relative; height: 400px; background: white; border-radius: 8px;">
                        <canvas id="${symbolSummary.symbol.toLowerCase()}-chart-canvas"></canvas>
                    </div>
                </div>
            `;
            
            return html;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('æš—å·è³‡ç”£ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ åˆæœŸåŒ–å®Œäº†');
            
            // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆlocalStorageï¼‰
            const savedData = localStorage.getItem('portfolioData');
            if (savedData) {
                try {
                    const portfolioData = JSON.parse(savedData);
                    // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚¿ãƒ–ã‚·ã‚¹ãƒ†ãƒ ã§è¡¨ç¤º
                    displayDashboard(portfolioData);
                    console.log('æ—¢å­˜ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                    localStorage.removeItem('portfolioData');
                    updateDataStatus(null);
                }
            } else {
                updateDataStatus(null);
            }
        });
    </script>
</body>
</html>